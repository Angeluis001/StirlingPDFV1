<!DOCTYPE html>
<html th:lang="${#locale.language}" th:lang-direction="#{language.direction}" xmlns:th="http://www.thymeleaf.org">

<th:block th:insert="~{fragments/common :: head(title=#{extractImages.title})}"></th:block>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
    

<body>
  <div id="page-container">
    <div id="content-wrap">
      <div th:insert="~{fragments/navbar.html :: navbar}"></div>
      <br> <br>
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <h2 th:text="#{extractImages.header}"></h2>

            <input type="file" id="pdfFile" accept=".pdf" />
            <canvas id="pdfCanvas" style="border:1px solid black;"></canvas>
            <input type="number" id="pageNumber" min="1" />
            <button id="goToPage">Go to Page</button>
            <button id="cropPdf">Crop PDF</button>
            <button id="downloadPdf">Download PDF</button>

            <Script>
            const pdfCanvas = document.getElementById('pdfCanvas');
            const ctx = pdfCanvas.getContext('2d');
            let pdfDoc = null;
            let currentPage = 1;
            let scaleFactor = 1.0;
            let cropper = null;

            async function renderPage(pageNumber) {
                const page = await pdfDoc.getPage(pageNumber);
                const viewport = page.getViewport({ scale: scaleFactor });
                pdfCanvas.width = viewport.width;
                pdfCanvas.height = viewport.height;
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport,
                };
                await page.render(renderContext);
            }

            document.getElementById('pdfFile').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const fileReader = new FileReader();
                fileReader.onload = async (e) => {
                    const typedArray = new Uint8Array(e.target.result);
                    pdfDoc = await pdfjsLib.getDocument(typedArray).promise;
                    await renderPage(currentPage);

                    if (cropper) cropper.destroy();
                    cropper = new Cropper(pdfCanvas, {
                    	  viewMode: 1,
                    	  autoCropArea: 1,
                    	  background: false, // Disable the default checkered background
                    	  modal: false, // Disable the default shading of the cropped area
                    	  dragMode: "crop",
                    	  cropBoxResizable: true,
                    	  guides: false, // Disable the default dashed crop box guides
                    	  // Set a custom background color with transparency
                    	  cropBox: {
                    	    background: "rgba(0, 0, 0, 0.2)",
                    	  },
                    	});

                };
                fileReader.readAsArrayBuffer(file);
            });

            document.getElementById('goToPage').addEventListener('click', async () => {
                currentPage = parseInt(document.getElementById('pageNumber').value);
                await renderPage(currentPage);
                if (cropper) cropper.destroy();
                cropper = new Cropper(pdfCanvas, {
                	  viewMode: 1,
                	  autoCropArea: 1,
                	  background: false, // Disable the default checkered background
                	  modal: false, // Disable the default shading of the cropped area
                	  dragMode: "crop",
                	  cropBoxResizable: true,
                	  guides: false, // Disable the default dashed crop box guides
                	  // Set a custom background color with transparency
                	  cropBox: {
                	    background: "rgba(0, 0, 0, 0.2)",
                	  },
                	});

            });

            document.getElementById('cropPdf').addEventListener('click', async () => {
                if (!cropper) return;

                const cropBoxData = cropper.getCropBoxData();
                const [x, y, width, height] = [cropBoxData.left, cropBoxData.top, cropBoxData.width, cropBoxData.height];

                const page = await pdfDoc.getPage(currentPage);
                const croppedPdf = await PDFLib.PDFDocument.create();
                const [croppedPage] = await croppedPdf.copyPages(pdfDoc, [currentPage - 1]);
                const cropBox = {
                    left: x / scaleFactor,
                    bottom: (pdfCanvas.height - y - height) / scaleFactor,
                    right: (x + width) / scaleFactor,
                    top: (pdfCanvas.height - y) / scaleFactor,
                };
                croppedPage.setCropBox(cropBox);
                croppedPdf.addPage(croppedPage);

                const croppedPdfBytes = await croppedPdf.save();
                const croppedPdfBlob = new Blob([croppedPdfBytes], { type: 'application/pdf' });

                const downloadLink = document.getElementById('downloadPdf');
                downloadLink.href = URL.createObjectURL(croppedPdfBlob);
                downloadLink.download = 'cropped.pdf';
            });
            
            document.getElementById('downloadPdf').addEventListener('click', async () => {
                if (!pdfDoc || !cropper) {
                    alert('No PDF available. Please load a PDF first.');
                    return;
                }

                const cropBoxData = cropper.getCropBoxData();
                const [x, y, width, height] = [cropBoxData.left, cropBoxData.top, cropBoxData.width, cropBoxData.height];

                const page = await pdfDoc.getPage(currentPage);
                const croppedPdf = await PDFLib.PDFDocument.create();
                if (!isNaN(currentPage)) {
                    const [croppedPage] = await croppedPdf.copyPages(pdfDoc, [currentPage - 1]);
                    const cropBox = {
                        left: x / scaleFactor,
                        bottom: (pdfCanvas.height - y - height) / scaleFactor,
                        right: (x + width) / scaleFactor,
                        top: (pdfCanvas.height - y) / scaleFactor,
                    };
                    croppedPage.setCropBox(cropBox);
                    croppedPdf.addPage(croppedPage);
                }

                const croppedPdfBytes = await croppedPdf.save();
                const croppedPdfBlob = new Blob([croppedPdfBytes], { type: 'application/pdf' });

                const downloadLink = document.getElementById('downloadPdf');
                downloadLink.href = URL.createObjectURL(croppedPdfBlob);
                downloadLink.download = 'cropped.pdf';
            });

            </Script>
          </div>
        </div>
      </div>
    </div>
    <div th:insert="~{fragments/footer.html :: footer}"></div>

</div>
</body>
</html>